#!/bin/bash

set -euo pipefail

# ============================================================
# CONFIGURE WHICH ALIGNERS TO RUN (1=run, 0=skip)
# ============================================================
RUN_BOWTIE2=0
RUN_BWA_MEM2=0
RUN_MINIMAP2=0

# Run variant calling analysis after completion (1=yes, 0=no)
# Set to 1 to run analysis even if variant calling was skipped (uses existing output)
RUN_BOWTIE2_ANALYSIS=1            # Run analysis for bowtie2
RUN_BWA_MEM2_ANALYSIS=1           # Run analysis for bwa-mem2
RUN_MINIMAP2_ANALYSIS=1            # Run analysis for minimap2
# ============================================================

# Configuration
SIM_OUTPUT_BASE="sim_output"
OUTPUT_BASE="sim_freebayes_out"
REFERENCE="ref.fa"
GROUND_TRUTH_VCF="all_genes_mutations.vcf"

# FreeBayes parameters
PLOIDY=1                    # Haploid (simulated data has one copy per gene)
MIN_ALT_COUNT=5             # Minimum number of reads supporting variant
THREADS=16
SNPS_ONLY=1                 # Call SNPs only (exclude indels)

# Build aligner list based on configuration
ALIGNERS=()
[ $RUN_BOWTIE2 -eq 1 ] && ALIGNERS+=("bowtie2")
[ $RUN_BWA_MEM2 -eq 1 ] && ALIGNERS+=("bwa-mem2")
[ $RUN_MINIMAP2 -eq 1 ] && ALIGNERS+=("minimap2")

# Build list of aligners for analysis (check before processing)
ANALYSIS_ALIGNERS_CHECK=()
[ $RUN_BOWTIE2_ANALYSIS -eq 1 ] && ANALYSIS_ALIGNERS_CHECK+=("bowtie2")
[ $RUN_BWA_MEM2_ANALYSIS -eq 1 ] && ANALYSIS_ALIGNERS_CHECK+=("bwa-mem2")
[ $RUN_MINIMAP2_ANALYSIS -eq 1 ] && ANALYSIS_ALIGNERS_CHECK+=("minimap2")

# Check if at least one aligner is selected for variant calling OR analysis
if [ ${#ALIGNERS[@]} -eq 0 ] && [ ${#ANALYSIS_ALIGNERS_CHECK[@]} -eq 0 ]; then
    echo "Error: No aligners selected! Set at least one RUN_* variable to 1 (for variant calling) or RUN_*_ANALYSIS to 1 (for analysis only)"
    exit 1
fi

# If variant calling is enabled, show that
if [ ${#ALIGNERS[@]} -gt 0 ]; then
    echo "Will run FreeBayes for aligners: ${ALIGNERS[*]}"
    echo "Mode: SNPs only (indels excluded)"
else
    echo "Variant calling skipped (all RUN_* flags are 0)"
    echo "Will run analysis only for: ${ANALYSIS_ALIGNERS_CHECK[*]}"
fi
echo ""

# Function to process a single aligner
process_aligner() {
    local ALIGNER="$1"
    local SIM_INPUT_DIR="${SIM_OUTPUT_BASE}/${ALIGNER}"
    local OUTPUT_DIR="${OUTPUT_BASE}/${ALIGNER}"
    local BAM_DIR="${SIM_INPUT_DIR}/${ALIGNER}_bam"
    local DIRECT_BAM="${SIM_INPUT_DIR}/direct/${ALIGNER}_direct.sorted.bam"
    
    echo "=========================================="
    echo "Processing aligner: $ALIGNER"
    echo "=========================================="
    echo "Input directory: $SIM_INPUT_DIR"
    echo "Output directory: $OUTPUT_DIR"
    echo ""
    
    # Check if input directory exists
    if [ ! -d "$SIM_INPUT_DIR" ]; then
        echo "Error: $SIM_INPUT_DIR not found. Run sim_mapping.sh first!"
        return 1
    fi
    
    # Create output directory
    mkdir -p "$OUTPUT_DIR"
    
    # Check for per-gene BAM files
    if [ ! -d "$BAM_DIR" ]; then
        echo "Error: BAM directory not found at $BAM_DIR"
        echo "Expected per-gene BAM files to be generated by mapper pipeline."
        return 1
    fi
    
    # Find all sorted BAM files
    BAM_FILES=$(find "$BAM_DIR" -name "*.sorted.bam" | sort)
    
    if [ -z "$BAM_FILES" ]; then
        echo "Error: No BAM files found in $BAM_DIR"
        return 1
    fi
    
    BAM_COUNT=$(echo "$BAM_FILES" | wc -l)
    echo "Found $BAM_COUNT per-gene BAM files"
    
    # Run FreeBayes on each gene's BAM file
    echo ""
    echo "Processing per-gene BAM files..."
    PROCESSED=0
    for bam_file in $BAM_FILES; do
        basename=$(basename "$bam_file" .sorted.bam)
        # Extract gene name (remove aligner prefix if present)
        gene=$(echo "$basename" | sed "s/^${ALIGNER}_//")
        vcf_output="${OUTPUT_DIR}/${ALIGNER}_${gene}.vcf"
        
        echo "  Calling variants for $gene..."
        
        freebayes \
            --bam "$bam_file" \
            --fasta-reference "$REFERENCE" \
            --ploidy "$PLOIDY" \
            --min-alternate-count "$MIN_ALT_COUNT" \
            --region "$gene" \
            -i \
            > "${vcf_output}.tmp" 2>&1 || {
                echo "    Warning: FreeBayes failed for $gene, creating empty VCF"
                # Create empty VCF with header
                echo "##fileformat=VCFv4.2" > "$vcf_output"
                echo "##source=freebayes" >> "$vcf_output"
                echo "#CHROM	POS	ID	REF	ALT	QUAL	FILTER	INFO	FORMAT" >> "$vcf_output"
                rm -f "${vcf_output}.tmp"
                continue
            }
        
        # Filter for SNPs only (keep header lines and variants where REF and ALT are single nucleotides)
        if [ -f "${vcf_output}.tmp" ]; then
            awk 'BEGIN{FS=OFS="\t"} /^#/ {print; next} {ref=$4; alt=$5; if(length(ref)==1 && length(alt)==1) print}' "${vcf_output}.tmp" > "$vcf_output"
            rm -f "${vcf_output}.tmp"
        fi
        
        PROCESSED=$((PROCESSED + 1))
    done
    
    if [ $PROCESSED -eq 0 ]; then
        echo "Error: No VCF files were created!"
        return 1
    fi
    
    echo "  Processed $PROCESSED genes"
    
    # Create aggregate VCF from all per-gene VCFs
    echo ""
    echo "Creating aggregate VCF from per-gene VCFs..."
    AGGREGATE_VCF="${OUTPUT_DIR}/${ALIGNER}_combined.vcf"
    
    # Check if any VCF files exist
    VCF_COUNT=$(find "$OUTPUT_DIR" -maxdepth 1 -name "${ALIGNER}_*.vcf" | grep -v "${ALIGNER}_combined.vcf" | grep -v "${ALIGNER}_direct.vcf" | wc -l)
    if [ $VCF_COUNT -eq 0 ]; then
        echo "Error: No per-gene VCF files found to combine!"
        return 1
    fi
    
    # Get header from first per-gene VCF
    first_vcf=$(find "$OUTPUT_DIR" -maxdepth 1 -name "${ALIGNER}_*.vcf" | grep -v "${ALIGNER}_combined.vcf" | grep -v "${ALIGNER}_direct.vcf" | head -1)
    if [ -n "$first_vcf" ]; then
        grep "^#" "$first_vcf" > "$AGGREGATE_VCF"
        
        # Append all variants (skip headers, exclude combined and direct)
        for vcf in "${OUTPUT_DIR}"/${ALIGNER}_*.vcf; do
            vcf_basename=$(basename "$vcf")
            if [ -f "$vcf" ] && [ "$vcf_basename" != "${ALIGNER}_combined.vcf" ] && [ "$vcf_basename" != "${ALIGNER}_direct.vcf" ]; then
                grep -v "^#" "$vcf" >> "$AGGREGATE_VCF" || true
            fi
        done
        
        # Sort by chromosome and position
        (grep "^#" "$AGGREGATE_VCF"; grep -v "^#" "$AGGREGATE_VCF" | sort -k1,1 -k2,2n) > "${AGGREGATE_VCF}.tmp"
        mv "${AGGREGATE_VCF}.tmp" "$AGGREGATE_VCF"
        echo "  Created aggregate VCF: $AGGREGATE_VCF"
    else
        echo "  Warning: No VCF files found for aggregation"
    fi
    
    # Process direct alignment BAM
    DIRECT_VCF="${OUTPUT_DIR}/${ALIGNER}_direct.vcf"
    echo ""
    if [ -f "$DIRECT_BAM" ]; then
        echo "Processing direct alignment BAM..."
        
        echo "  Calling variants from direct alignment..."
        
        freebayes \
            --bam "$DIRECT_BAM" \
            --fasta-reference "$REFERENCE" \
            --ploidy "$PLOIDY" \
            --min-alternate-count "$MIN_ALT_COUNT" \
            -i \
            > "${DIRECT_VCF}.tmp" 2>&1 || {
                echo "    Warning: FreeBayes failed for direct alignment, creating empty VCF"
                # Create empty VCF with header
                echo "##fileformat=VCFv4.2" > "$DIRECT_VCF"
                echo "##source=freebayes" >> "$DIRECT_VCF"
                echo "#CHROM	POS	ID	REF	ALT	QUAL	FILTER	INFO	FORMAT" >> "$DIRECT_VCF"
                rm -f "${DIRECT_VCF}.tmp"
            }
        
        # Filter for SNPs only (keep header lines and variants where REF and ALT are single nucleotides)
        if [ -f "${DIRECT_VCF}.tmp" ]; then
            awk 'BEGIN{FS=OFS="\t"} /^#/ {print; next} {ref=$4; alt=$5; if(length(ref)==1 && length(alt)==1) print}' "${DIRECT_VCF}.tmp" > "$DIRECT_VCF"
            rm -f "${DIRECT_VCF}.tmp"
        fi
        
        echo "  Created direct alignment VCF: $DIRECT_VCF"
    else
        echo "  Warning: Direct alignment BAM not found at $DIRECT_BAM, skipping..."
    fi
    
    echo ""
    echo "Completed processing $ALIGNER"
    echo ""
}

# Process all selected aligners (only if variant calling is enabled)
if [ ${#ALIGNERS[@]} -gt 0 ]; then
    ERRORS=0
    for ALIGNER in "${ALIGNERS[@]}"; do
        if ! process_aligner "$ALIGNER"; then
            echo "✗ Failed processing $ALIGNER"
            ERRORS=$((ERRORS + 1))
        else
            echo "✓ Successfully processed $ALIGNER"
        fi
        echo ""
    done

    # Summary
    echo "=========================================="
    if [ $ERRORS -eq 0 ]; then
        echo "Variant calling complete for all aligners!"
    else
        echo "Variant calling complete with $ERRORS error(s)!"
    fi
    echo "=========================================="
    echo ""
    echo "Output structure:"
    echo "  $OUTPUT_BASE/"
    for ALIGNER in "${ALIGNERS[@]}"; do
        echo "    ${ALIGNER}/"
        echo "      - Per-gene VCFs: ${ALIGNER}_*.vcf"
        echo "      - Aggregate VCF: ${ALIGNER}_combined.vcf"
        echo "      - Direct alignment: ${ALIGNER}_direct.vcf"
    done
    echo ""
    echo "Ground truth: $GROUND_TRUTH_VCF"
    echo ""
else
    echo "Skipping variant calling (using existing VCF files)"
    echo ""
fi

# Build list of aligners for analysis based on individual flags
ANALYSIS_ALIGNERS=()
[ $RUN_BOWTIE2_ANALYSIS -eq 1 ] && ANALYSIS_ALIGNERS+=("bowtie2")
[ $RUN_BWA_MEM2_ANALYSIS -eq 1 ] && ANALYSIS_ALIGNERS+=("bwa-mem2")
[ $RUN_MINIMAP2_ANALYSIS -eq 1 ] && ANALYSIS_ALIGNERS+=("minimap2")

# Run variant calling analysis if any aligner has analysis enabled
if [ ${#ANALYSIS_ALIGNERS[@]} -gt 0 ]; then
    echo "=========================================="
    echo "Running variant calling analysis for selected aligners..."
    echo "Aligners: ${ANALYSIS_ALIGNERS[*]}"
    echo "=========================================="
    echo ""
    
    # Function to run variant analysis for a single aligner
    run_variant_analysis() {
        local ALIGNER="$1"
        local LOG_FILE="sim_variant_calling_analysis/${ALIGNER}.log"
        mkdir -p "$(dirname "$LOG_FILE")"
        
        (
            set -euo pipefail
            echo "Analyzing variants for $ALIGNER..."
            echo "Started at: $(date)"
            python variant_calling_analysis.py --aligner "$ALIGNER"
            echo "Completed at: $(date)"
        ) > "$LOG_FILE" 2>&1
    }
    
    # Run all variant analyses in parallel
    VARIANT_ANALYSIS_PIDS=()
    for ALIGNER in "${ANALYSIS_ALIGNERS[@]}"; do
        run_variant_analysis "$ALIGNER" &
        VARIANT_ANALYSIS_PIDS+=($!)
        echo "Started variant analysis for $ALIGNER (PID: ${VARIANT_ANALYSIS_PIDS[-1]})"
    done
    
    # Wait for all variant analyses and check for errors
    VARIANT_ANALYSIS_ERRORS=0
    for i in "${!ANALYSIS_ALIGNERS[@]}"; do
        ALIGNER="${ANALYSIS_ALIGNERS[$i]}"
        PID="${VARIANT_ANALYSIS_PIDS[$i]}"
        echo "Waiting for variant analysis of $ALIGNER (PID: $PID)..."
        if wait $PID; then
            echo "✓ Variant analysis for $ALIGNER completed successfully"
        else
            echo "✗ Variant analysis for $ALIGNER failed! Check sim_variant_calling_analysis/${ALIGNER}.log"
            VARIANT_ANALYSIS_ERRORS=$((VARIANT_ANALYSIS_ERRORS + 1))
        fi
    done
    
    echo ""
    echo "=========================================="
    if [ $VARIANT_ANALYSIS_ERRORS -eq 0 ]; then
        echo "Variant calling analysis complete!"
    else
        echo "Variant calling analysis complete with $VARIANT_ANALYSIS_ERRORS error(s)!"
    fi
    echo "=========================================="
    echo "Results saved to:"
    echo "  sim_variant_calling_analysis/"
    for ALIGNER in "${ANALYSIS_ALIGNERS[@]}"; do
        echo "    ${ALIGNER}/"
    done
fi
